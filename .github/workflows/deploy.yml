  name: Deploy to Digital Ocean

  on:
    push:
      branches: [ main, master ]
    pull_request:
      branches: [ main, master ]

  jobs:
    test:
      runs-on: ubuntu-latest
      
      strategy:
        matrix:
          node-version: [18.x, 20.x, 22.x]

      steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Run tests (if you have them)
        run: npm test || echo "No tests found"

      - name: TypeScript type check
        run: npx tsc --noEmit

    deploy:
      needs: test
      runs-on: ubuntu-latest
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      
      steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USERNAME }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 22
          script: |
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to app directory
            cd /var/www/strongin30days/strong_in_3Odays_Back_end
            
            # Pull latest code
            git pull origin main
            
            # Create or update .env file with database configuration
            # Use GitHub Secrets for sensitive values
            cat > .env << 'EOF'
            NODE_ENV=production
            PORT=3000

            # Database configuration
            DB_NAME=strong_in_30
            DB_USER=strongin30
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_HOST=localhost
            DB_PORT=5432

            # JWT Configuration
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
            JWT_EXPIRE=30d
            JWT_COOKIE_EXPIRE=30
            JWT_EXPIRES_IN=1d
            JWT_REFRESH_EXPIRES_IN=30d
            JWT_COOKIE_EXPIRE=30

            # Other environment variables
            LOG_LEVEL=info
            EOF
            
            # Set proper permissions for .env
            chmod 600 .env
            
            # Create/update ecosystem.config.js
            cat > ecosystem.config.js << EOF
            module.exports = {
              apps: [{
                name: 'strongin30-app',
                script: 'dist/server.js',
                instances: 1,
                autorestart: true,
                watch: false,
                max_memory_restart: '1G',
                env: {
                  NODE_ENV: 'production',
                  PORT: 3000,
                  DB_HOST: 'localhost',
                  DB_PORT: 5432,
                  DB_NAME: 'strong_in_30',
                  DB_USER: 'strongin30',
                  DB_PASSWORD: '${{ secrets.DB_PASSWORD }}',
                  JWT_SECRET: '${{ secrets.JWT_SECRET }}',
                  JWT_REFRESH_SECRET: '${{ secrets.JWT_REFRESH_SECRET }}',
                  JWT_EXPIRE: '30d',
                  JWT_EXPIRES_IN: '1d',
                  JWT_REFRESH_EXPIRES_IN: '30d',
                  JWT_COOKIE_EXPIRE: 30,
                  LOG_LEVEL: 'info'
                }
              }]
            };
            EOF
            
            # Install dependencies
            npm ci --only=production
            
            # Build TypeScript
            npm run build -- --env=production
            
            # Run database migrations if sequelize-cli is available
            if [ -f node_modules/.bin/sequelize-cli ] || [ -f node_modules/.bin/sequelize ]; then
              npx sequelize-cli db:migrate 2>/dev/null || echo "Migrations not found or failed"
            fi
            
            # Restart application with PM2
            pm2 delete strongin30-app || true
            pm2 start ecosystem.config.js
            
            # Save PM2 process list
            pm2 save
            
            # Setup PM2 startup if not already configured
            if [ ! -f /etc/systemd/system/pm2-$USER.service ]; then
              pm2 startup systemd -u $USER --hp /home/$USER
            fi
            
            echo "âœ… Deployment complete!"